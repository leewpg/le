        // Game data with categories, links, and names
        const games = [

{
                id: 1,
                name: "Aviator",
                category: "Crash",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQbCsqhz_zJk2onAvdWOGrtcPanMe74X2gNjg&s",
                playLink: "a",
                tryLink: "https://aviatordemo.co.za/"
            },


{
                id: 2,
                name: "Super ACE",
                category: "Slots",
                image: "https://image.winudf.com/v2/image1/Y29tLmhvdDc3Ny5zbG90cGx1cy53aW5qYWNrcG90X2ljb25fMTY2NzM1NTc1MV8wMzg/icon.png?w=280&fakeurl=1",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/49?showGame=true"
            },


{
                id: 3,
                name: "Crazy Time",
                category: "Live",
                image: "https://media.royalpanda.com/images/games/crazy-time-live/crazy-time-live-tile.jpg",
                playLink: "a",
                tryLink: ""
            },


{
                id: 4,
                name: "Lucky Jaguar",
                category: "Slots",
                image: "https://static.casino.guru/pict/1035203/Lucky-Jaguar2.png?timestamp=1734087977000&imageDataId=1097597&width=320&height=247",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/421?showGame=true"
            },


{
                id: 5,
                name: "Wild Bounty Showdown",
                category: "Slots",
                image: "https://casinos.com/cdn-cgi/image/f=webp,q=86,g=auto/https://objects.kaxmedia.com/auto/o/211735/41925e8bec.jpeg",
                playLink: "a",
                tryLink: "https://www.demoslot.com/free-slots/wild-bounty-showdown-slot/#demo"
            },


{
                id: 6,
                name: "Chicken Road",
                category: "Lottery",
                image: "https://s3-eu-west-1.amazonaws.com/tpd/logos/686b9ab5885e63ea1c7ca7b6/0x0.png",
                playLink: "a",
                tryLink: "https://chickenroadsfr.org/en/"
            },


{
                id: 7,
                name: "Sic Bo",
                category: "Card",
                image: "https://embed.linuxg.net/jili/sic-bo.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/125?showGame=true"
            },


{
                id: 8,
                name: "Super Element",
                category: "Slots",
                image: "https://fachaigaming.com/uploads/2680bd43-32bc-4498-aef5-c15984da0386-22055_meta_en.jpg",
                playLink: "a",
                tryLink: "https://www.casinorating.com/games/fa-chai-gaming/slots/super-elements#"
            },


{
                id: 9,
                name: "Bank Fever 2",
                category: "Slots",
                image: "https://hotdog-gaming.com/img/demopage-pic-bank-fever2.png",
                playLink: "a",
                tryLink: "https://cdn.coconut88.com/fun987/?extt=93c3854d-20dc-4e8f-99a9-7d9241a1f057&q=IA%3D%3D%7CNGRmZjQwOGItMmFhYi00YmRhLWFhOGYtMDcyMmU4ZjRlMDI2%7CZnVuT3A%3D&m7=24560&param7=en-us&sc=RG"
            },


{
                id: 10,
                name: "Funky Time",
                category: "Live",
                image: "https://games.evolution.com/wp-content/uploads/2023/05/funky_time_logo_eng_2023_01.svg",
                playLink: "a",
                tryLink: ""
            },


{
                id: 11,
                name: "Roulette",
                category: "Live",
                image: "https://res.cloudinary.com/kalispel/image/upload/f_auto,q_auto/v1714690433/Craft%20Images/Roulette_header_2750x1600_jsg1ap.jpg",
                playLink: "a",
                tryLink: "https://www.247roulette.org/"
            },


{
                id: 12,
                name: "Magic Ace Wild Lock",
                category: "Slots",
                image: "https://assets.slotslaunch.com/29686/magic-ace-wild-lock.jpg",
                playLink: "a",
                tryLink: "https://www.lionbonuses.com/blog/slots/magic-ace-wild-lock/"
            },


{
                id: 13,
                name: "Lucky Neko",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/08/LUCKY-NEKO-PG-SOFT.png",
                playLink: "a",
                tryLink: "https://slotslaunch.com/pocket-games-soft/lucky-neko"
            },


{
                id: 14,
                name: "Coin Toss",
                category: "Card",
                image: "https://7cricinr.com/blog/wp-content/uploads/2023/08/Coin-Toss-by-Kingmaker.webp",
                playLink: "a",
                tryLink: "https://linuxg.net/game/coin-toss-by-kingmaker/"
            },


{
                id: 15,
                name: "Mega Ball",
                category: "Live",
                image: "https://media.royalpanda.com/images/games/live-mega-ball/live-mega-ball-tile.jpg",
                playLink: "a",
                tryLink: ""
            },


{
                id: 16,
                name: "Charge Buffalo",
                category: "Slots",
                image: "https://embed.linuxg.net/jili/charge-buffalo.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/47?showGame=true"
            },


{
                id: 17,
                name: "Fruity Bonanza",
                category: "Slots",
                image: "https://assets.slotslaunch.com/14504/fruity-bonanza.jpg",
                playLink: "a",
                tryLink: "https://slotcatalog.com/en/slots/Fruity-Bonanza"
            },


{
                id: 18,
                name: "7Up 7Down",
                category: "Card",
                image: "https://games.okbet.com/wp-content/uploads/2024/10/7up7down-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/124?showGame=true"
            },


{
                id: 19,
                name: "MonoPoly",
                category: "Live",
                image: "https://www.olg.ca/content/dam/olg/web/product/casino/2023/jan-march-2023/game-build-sprint-march-13-27/monopoly-live/ewma/desktop-carousel-logo.png",
                playLink: "a",
                tryLink: ""
            },


{
                id: 20,
                name: "Color Game",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/08/color-game-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/197?showGame=true"
            },


{
                id: 21,
                name: "Mega Ace",
                category: "Slots",
                image: "https://embed.linuxg.net/jili/mega-ace.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/134?showGame=true"
            },


{
                id: 22,
                name: "Fortune Games",
                category: "Slots",
                image: "https://s.cafebazaar.ir/images/icons/com.fufafa.jogo.fortuneGems.free.games-004d31cf-2965-44a7-9c92-6162447dcdf9_512x512.png?x-img=v1/resize,h_256,w_256,lossless_false/optimize",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/109?showGame=true"
            },


{
                id: 23,
                name: "Fortune Games 2",
                category: "Slots",
                image: "https://image.winudf.com/v2/image1/Y29tLmZ1ZmFmYS5qb2dvLmZvcnR1bmUuZ2Vtcy50d28uZnJlZS5nYW1lc19pY29uXzE2OTg4MzQ3NTRfMDQ3/icon.png?w=186&fakeurl=1",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/223?showGame=true"
            },


{
                id: 24,
                name: "Fortune Games 3",
                category: "Slots",
                image: "https://static.templodeslots.es/pict/964816/Fortune-Gems-3.png?timestamp=1727156324000&imageDataId=1015210&width=320&height=247",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/300?showGame=true"
            },


{
                id: 25,
                name: "Ali Baba",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/10/ali-baba-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/110?showGame=true"
            },


{
                id: 26,
                name: "Crown Of Fortune",
                category: "Slots",
                image: "https://assets.slotslaunch.com/38456/01K5TAX29NVCAFEGRK588H9F87.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/621?showGame=true"
            },


{
                id: 27,
                name: "Super Rioh",
                category: "Slots",
                image: "https://assets.slotslaunch.com/11367/552x380_EN_GAMEID_100.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/100?showGame=true"
            },


{
                id: 28,
                name: "Medusa",
                category: "Slots",
                image: "https://frpyol0mhkke.compat.objectstorage.eu-frankfurt-1.oraclecloud.com/lpcms-assets/thumbnail/68d1b560a1bf4Medusa/79a4e9e9f468e277dcff8dff965a67bb.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/101?showGame=true"
            },


{
                id: 29,
                name: "Romax",
                category: "Slots",
                image: "https://embed.linuxg.net/jili/romax.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/102?showGame=true"
            },


{
                id: 30,
                name: "Golden Empire",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/08/golden-empire-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/103?showGame=true"
            },


{
                id: 31,
                name: "Magic Lamp",
                category: "Slots",
                image: "https://static.casino.guru/pict/554682/Magic-Lamp.png?timestamp=1693809786000&imageDataId=598906&width=320&height=247",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/108?showGame=true"
            },


{
                id: 32,
                name: "Agent ace",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/09/agent-ace-jili-slot-game.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/115?showGame=true"
            },


{
                id: 33,
                name: "Happy Taxi",
                category: "Slots",
                image: "https://embed.linuxg.net/jili/happy-taxi.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/116?showGame=true"
            },


{
                id: 34,
                name: "iRich Bingo",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/09/irich-bingo-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/122?showGame=true"
            },


{
                id: 35,
                name: "Dragon and Tiger",
                category: "Card",
                image: "https://deco-factory-hoesbach.de/_next/image?url=https%3A%2F%2Ffrpyol0mhkke.compat.objectstorage.eu-frankfurt-1.oraclecloud.com%2Flpcms-assets%2Fthumbnail%2F68d16a30b6a02DragonandTigerTaDaGaming%2F64c7e0fc152fe52071c331f3629c6d23.png&w=750&q=75",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/123?showGame=true"
            },


{
                id: 36,
                name: "Bone Fortune",
                category: "Slots",
                image: "https://m.media-amazon.com/images/I/91RqWvvK83L.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/126?showGame=true"
            },


{
                id: 37,
                name: "Ludo",
                category: "Card",
                image: "https://static.casino.guru/pict/555164/Ludo.png?timestamp=1693811762000&imageDataId=599763&width=320&height=247",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/128?showGame=true"
            },


{
                id: 38,
                name: "ThorX",
                category: "Slots",
                image: "https://games.okbet.com/wp-content/uploads/2024/09/thor-x-jili.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/130?showGame=true"
            },


{
                id: 39,
                name: "Mayan Empire",
                category: "Slots",
                image: "https://assets.slotslaunch.com/11339/552x380_EN_GAMEID_135.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/135?showGame=true"
            },


{
                id: 40,
                name: "Samba",
                category: "Slots",
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRGpZBtJT8D6zFahrF1f3Pgp1ciascfHnfYew&s",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/136?showGame=true"
            },


{
                id: 41,
                name: "Golad Rush",
                category: "Slots",
                image: "https://media.21.co.uk/images/games/gold-rush/gold-rush-square.jpg",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/137?showGame=true"
            },


{
                id: 42,
                name: "Fortune Bingo",
                category: "Slots",
                image: "https://static.templodeslots.es/pict/555086/Fortune-Bingo.png?timestamp=1693811600000&imageDataId=599620&width=320&height=247",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/139?showGame=true"
            },


{
                id: 43,
                name: "World Cup",
                category: "Slots",
                image: "https://embed.linuxg.net/jili/world-cup.webp",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/146?showGame=true"
            },


{
                id: 45,
                name: "Golden Empire",
                category: "",
                image: "https://st.softgamings.com/uploads/GoldenEmpire.png",
                playLink: "a",
                tryLink: "https://tadagaming.com/PlusIntro/103?showGame=true"
            },


        ];


// DOM elements
const gamesContainer = document.getElementById('gamesContainer');
const menuItems = document.querySelectorAll('.menu-item');
const pageContents = document.querySelectorAll('.page-content');
const navItems = document.querySelectorAll('.nav-item');

// Function to render games based on category
function renderGames(category = 'all') {
    gamesContainer.innerHTML = '';
    
    const filteredGames = category === 'all' 
        ? games 
        : games.filter(game => game.category === category);
    
    if (filteredGames.length === 0) {
        gamesContainer.innerHTML = '<div class="no-games">No games found in this category</div>';
        return;
    }
    
    filteredGames.forEach(game => {
        const gameCard = document.createElement('div');
        gameCard.className = 'game-card';
        gameCard.innerHTML = `
            <div class="game-image-container">
                <img src="${game.image}" alt="${game.name}" class="game-image">
                <div class="game-overlay">
                    <a href="${game.playLink}" target="_self" class="play-btn play-game">PLAY</a>
                    <a href="${game.tryLink}" target="_self" class="try-btn">TRY</a>
                </div>
            </div>
            <div class="game-name">${game.name}</div>
        `;
        gamesContainer.appendChild(gameCard);
    });
}

// Function to show specific page - UPDATED with referral support
function showPage(pageId) {
    console.log('Showing page:', pageId);
    
    // Check if user is logged in for protected pages
    const protectedPages = ['referralPage', 'depositPage', 'rewardsPage', 'accountPage'];
    
    if (protectedPages.includes(pageId) && !simpleAuth.isLoggedIn()) {
        // Show login modal instead of protected page
        createAuthModal();
        document.getElementById('authModal').style.display = 'block';
        return;
    }
    
    // Hide all pages
    pageContents.forEach(page => {
        page.classList.remove('active');
    });
    
    // Show selected page
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    // Update active nav item
    navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) {
            item.classList.add('active');
        }
    });
    
    // Initialize page-specific functionality
    switch (pageId) {
        case 'referralPage':
            if (simpleAuth.isLoggedIn()) {
                loadReferralData();
            }
            break;
            
        case 'depositPage':
            if (typeof initDepositPage === 'function') {
                setTimeout(initDepositPage, 100);
            }
            break;
    }
    
    // Update page content if user is logged in
    if (simpleAuth.isLoggedIn() && simpleAuth.currentUser) {
        switch (pageId) {
            case 'accountPage':
                simpleAuth.updateAccountInfo();
                break;
            case 'referralPage':
                simpleAuth.updateReferralPage();
                break;
            case 'rewardsPage':
                simpleAuth.updateRewardsPage();
                break;
            case 'depositPage':
                simpleAuth.updateDepositPage();
                break;
        }
    }
}
// Initialize with all games
renderGames();

// Category filtering
menuItems.forEach(item => {
    item.addEventListener('click', function() {
        // Update active menu item
        menuItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        
        // Filter games
        const category = this.getAttribute('data-category');
        renderGames(category);
    });
});

// Page navigation - UPDATED
navItems.forEach(item => {
    item.addEventListener('click', function() {
        const pageId = this.getAttribute('data-page');
        showPage(pageId);
    });
});

// Carousel functionality
let currentSlide = 0;
const slides = document.querySelectorAll('.carousel-slide');
const dots = document.querySelectorAll('.dot');

function showSlide(n) {
    slides.forEach(slide => slide.classList.remove('active'));
    dots.forEach(dot => dot.classList.remove('active'));
    
    currentSlide = (n + slides.length) % slides.length;
    
    slides[currentSlide].classList.add('active');
    dots[currentSlide].classList.add('active');
}

// Auto slide change
setInterval(() => {
    showSlide(currentSlide + 1);
}, 5000);

// Add click events to dots
dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
        showSlide(index);
    });
});

// Login button functionality - UPDATED
document.querySelector('.login-btn').addEventListener('click', function() {
    if (simpleAuth.isLoggedIn()) {
        // User is logged in, show logout confirmation
        if (confirm('Are you sure you want to logout?')) {
            simpleAuth.logout();
        }
    } else {
        // User is not logged in, show auth modal
        createAuthModal();
        const modal = document.getElementById('authModal');
        if (modal) {
            modal.style.display = 'block';
        }
    }
});


// Claim bonus buttons
document.querySelectorAll('.rewards-grid .play-btn').forEach(button => {
    button.addEventListener('click', function() {
        alert('Bonus claimed successfully!');
    });
});

// Account action buttons
document.querySelectorAll('.action-btn').forEach(button => {
    button.addEventListener('click', function() {
        const action = this.textContent.trim();
    });
});

// Auth Modal Functions
function createAuthModal() {
    // Remove existing modal if any
    const existingModal = document.getElementById('authModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div id="authModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 style="color: #ffcc00; text-align: center; margin-bottom: 20px;">LUCKY SPIN CASINO</h2>
                <div class="auth-tabs">
                    <button class="tab-btn active" data-tab="login">Login</button>
                    <button class="tab-btn" data-tab="signup">Register</button>
                </div>
                
                <div id="loginTab" class="tab-content active">
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label">Username or Mobile</label>
                            <input type="text" class="form-input" id="loginUsername" required placeholder="Enter username or mobile">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="loginPassword" required placeholder="Enter password">
                        </div>
                        <button type="submit" class="submit-btn">LOGIN</button>
                    </form>
                </div>
                
                <div id="signupTab" class="tab-content">
                    <form id="signupForm">
                        <div class="form-group">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-input" id="signupUsername" required placeholder="Choose a username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number *</label>
                            <input type="tel" class="form-input" id="signupMobile" required placeholder="Enter mobile number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-input" id="signupPassword" required minlength="6" placeholder="At least 6 characters">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email (Optional)</label>
                            <input type="email" class="form-input" id="signupEmail" placeholder="Optional email">
                        </div>
                        <div class="form-group">
    <label class="form-label">Referral Code (Optional)</label>
    <input type="text" class="form-input" id="signupReferralCode" placeholder="Enter referral code if any">
</div>
                        <button type="submit" class="submit-btn">CREATE ACCOUNT</button>
                    </form>
                </div>
                
                <div id="authMessage" class="auth-message"></div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add modal event listeners
    const modal = document.getElementById('authModal');
    const closeBtn = modal.querySelector('.close');
    const tabBtns = modal.querySelectorAll('.tab-btn');
    const tabContents = modal.querySelectorAll('.tab-content');
    
    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        });
    });
    
    // Form submissions
    document.getElementById('loginForm').addEventListener('submit', handleSimpleLogin);
    document.getElementById('signupForm').addEventListener('submit', handleSimpleSignup);
    
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

async function handleSimpleLogin(e) {
    e.preventDefault();
    const identifier = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const messageEl = document.getElementById('authMessage');
    
    try {
        messageEl.textContent = 'Logging in...';
        messageEl.className = 'auth-message info';
        
        const result = await simpleAuth.login(identifier, password);
        
        if (result.success) {
            messageEl.textContent = 'Login successful!';
            messageEl.className = 'auth-message success';
            
            setTimeout(() => {
                const modal = document.getElementById('authModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                messageEl.textContent = '';
                document.getElementById('loginForm').reset();
            }, 1000);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'auth-message error';
    }
}

async function handleSimpleSignup(e) {
    e.preventDefault();
    const username = document.getElementById('signupUsername').value;
    const mobile = document.getElementById('signupMobile').value;
    const password = document.getElementById('signupPassword').value;
    const email = document.getElementById('signupEmail').value;
    const referralCode = document.getElementById('signupReferralCode').value; // নতুন লাইন
    const messageEl = document.getElementById('authMessage');
    
    try {
        messageEl.textContent = 'Creating account...';
        messageEl.className = 'auth-message info';
        
        // রেফারেল কোড সহ রেজিস্ট্রেশন কল করুন
        const result = await simpleAuth.register(username, mobile, password, email, referralCode);
        
        if (result.success) {
            messageEl.textContent = 'Account created successfully! Welcome to Lucky Spin!';
            messageEl.className = 'auth-message success';
            
            setTimeout(() => {
                const modal = document.getElementById('authModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                messageEl.textContent = '';
                document.getElementById('signupForm').reset();
            }, 2000);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        messageEl.textContent = error.message;
        messageEl.className = 'auth-message error';
    }
}

// Temporary fix: Clear corrupted auth data
function clearAuthData() {
    const savedUser = localStorage.getItem('casino_user');
    if (savedUser) {
        try {
            const user = JSON.parse(savedUser);
            if (!user.id || !user.username) {
                localStorage.removeItem('casino_user');
                console.log('Cleared corrupted auth data');
            }
        } catch (error) {
            localStorage.removeItem('casino_user');
            console.log('Cleared invalid auth data');
        }
    }
}

// Run this on page load
document.addEventListener('DOMContentLoaded', function() {
    clearAuthData();
});


// Global function for bonus claiming
async function claimBonus(bonusType, event = null) {
    if (!simpleAuth.isLoggedIn()) {
        alert('Please login to claim bonuses');
        return;
    }

    try {
        // Get bonus details from available_bonuses table
        const { data: bonusData, error: bonusFetchError } = await supabase
            .from('available_bonuses')
            .select('*')
            .eq('bonus_type', bonusType)
            .eq('is_active', true)
            .single();

        if (bonusFetchError || !bonusData) {
            throw new Error('Bonus not available or not found');
        }

        const amount = bonusData.amount;

        // Check if user already claimed this bonus
        const { data: existingClaims, error: checkError } = await supabase
            .from('user_bonuses')
            .select('id')
            .eq('user_id', simpleAuth.currentUser.id)
            .eq('bonus_type', bonusType);

        if (checkError) throw checkError;

        if (existingClaims && existingClaims.length >= bonusData.max_claims_per_user) {
            alert(`You have already claimed the maximum times for ${bonusData.bonus_name}!`);
            return;
        }

        // Get the button safely
        let button;
        if (event && event.target) {
            button = event.target;
        } else {
            // Fallback: find button by bonus type
            button = document.querySelector(`[data-bonus-type="${bonusType}"]`);
        }

        // Show loading state if button found
        if (button) {
            button.textContent = 'Claiming...';
            button.disabled = true;
        }

        // Add bonus to user's wallet
        const newBalance = (simpleAuth.currentUser.balance || 0) + amount;
        
        // Update user balance in database
        const { data: updatedUser, error: updateError } = await supabase
            .from('profiles')
            .update({ balance: newBalance })
            .eq('id', simpleAuth.currentUser.id)
            .select()
            .single();

        if (updateError) throw updateError;

        // Record the bonus claim
        const { error: bonusError } = await supabase
            .from('user_bonuses')
            .insert([
                {
                    user_id: simpleAuth.currentUser.id,
                    bonus_type: bonusType,
                    amount: amount,
                    description: bonusData.bonus_name
                }
            ]);

        if (bonusError) throw bonusError;

        // Record transaction
        const { error: txError } = await supabase
            .from('transactions')
            .insert([
                {
                    user_id: simpleAuth.currentUser.id,
                    type: 'bonus',
                    amount: amount,
                    description: `${bonusData.bonus_name} Claimed`,
                    status: 'completed'
                }
            ]);

        if (txError) throw txError;

        // Update local user data
        simpleAuth.currentUser.balance = newBalance;
        localStorage.setItem('casino_user', JSON.stringify(simpleAuth.currentUser));
        
        // Update UI
        simpleAuth.updateAllUserSections();

        alert(`🎉 Success! $${amount} ${bonusData.bonus_name} has been added to your wallet!`);
        
        // Update the button if found
        if (button) {
            button.textContent = 'CLAIMED';
            button.style.background = '#4CAF50';
            button.disabled = true;
        }

    } catch (error) {
        console.error('Error claiming bonus:', error);
        alert('Failed to claim bonus: ' + error.message);
        
        // Reset button if found
        let button;
        if (event && event.target) {
            button = event.target;
        } else {
            button = document.querySelector(`[data-bonus-type="${bonusType}"]`);
        }
        
        if (button) {
            button.textContent = 'CLAIM';
            button.disabled = false;
        }
    }
}

// Add event listeners for bonus buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('claim-bonus-btn')) {
        const bonusType = e.target.getAttribute('data-bonus-type');
        claimBonus(bonusType, e);
    }
});


// Payment method dropdown handler
const paymentMethodSelect = document.getElementById('paymentMethod');
if (paymentMethodSelect) {
    paymentMethodSelect.addEventListener('change', function() {
        const paymentNumberInput = document.getElementById('paymentNumber');
        const selectedMethod = this.value;

        const paymentNumbers = {
            bkash: "01712345678",
            nagad: "01887654321", 
            rocket: "01911223344",
            crypto: "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh"
        };

        if (selectedMethod && paymentNumbers[selectedMethod]) {
            paymentNumberInput.value = paymentNumbers[selectedMethod];
        } else {
            paymentNumberInput.value = "";
        }
    });
}


// Account Actions Functions

// Show Transaction History
async function showTransactionHistory() {
    if (!simpleAuth.isLoggedIn()) {
        alert('Please login to view transaction history');
        return;
    }

    try {
        const { data: transactions, error } = await supabase
            .from('transactions')
            .select('*')
            .eq('user_id', simpleAuth.currentUser.id)
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) throw error;

        displayTransactionHistory(transactions);
        document.getElementById('transactionHistoryModal').style.display = 'block';

    } catch (error) {
        console.error('Error loading transactions:', error);
        alert('Failed to load transaction history: ' + error.message);
    }
}

function displayTransactionHistory(transactions) {
    const tbody = document.getElementById('transactionHistoryBody');
    tbody.innerHTML = '';

    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">
                    No transactions found
                </td>
            </tr>
        `;
        return;
    }

    transactions.forEach(tx => {
        const row = document.createElement('tr');
        const date = new Date(tx.created_at).toLocaleDateString();
        const amountColor = tx.type === 'deposit' || tx.type === 'bonus' ? '#4CAF50' : '#f44336';
        const amountSign = tx.type === 'deposit' || tx.type === 'bonus' ? '+' : '-';
        
        row.innerHTML = `
            <td>${date}</td>
            <td>
                <span style="color: ${tx.type === 'deposit' ? '#4CAF50' : tx.type === 'bonus' ? '#ffcc00' : '#2196F3'}">
                    ${tx.type?.toUpperCase() || 'N/A'}
                </span>
            </td>
            <td style="color: ${amountColor}; font-weight: bold;">
                ${amountSign}$${Math.abs(tx.amount).toFixed(2)}
            </td>
            <td>${tx.description || 'N/A'}</td>
            <td>
                <span style="color: ${tx.status === 'completed' ? '#4CAF50' : '#ff9800'}">
                    ${tx.status?.toUpperCase() || 'COMPLETED'}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Show Edit Profile
function showEditProfile() {
    if (!simpleAuth.isLoggedIn()) {
        alert('Please login to edit profile');
        return;
    }

    // Fill form with current user data
    document.getElementById('editProfileUsername').value = simpleAuth.currentUser.username || '';
    document.getElementById('editProfileEmail').value = simpleAuth.currentUser.email || '';
    document.getElementById('editProfileMobile').value = simpleAuth.currentUser.mobile || '';

    document.getElementById('editProfileModal').style.display = 'block';
}

// Update Profile
document.addEventListener('DOMContentLoaded', function() {
    // Edit Profile Form
    const editProfileForm = document.getElementById('editProfileForm');
    if (editProfileForm) {
        editProfileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await updateUserProfile();
        });
    }

    // Change Password Form
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await changeUserPassword();
        });
    }
});

async function updateUserProfile() {
    try {
        const username = document.getElementById('editProfileUsername').value;
        const email = document.getElementById('editProfileEmail').value;
        const mobile = document.getElementById('editProfileMobile').value;

        if (!username || !mobile) {
            alert('Username and mobile number are required');
            return;
        }

        // Check if username is already taken (excluding current user)
        const { data: existingUser, error: checkError } = await supabase
            .from('profiles')
            .select('id')
            .eq('username', username)
            .neq('id', simpleAuth.currentUser.id)
            .single();

        if (existingUser && !checkError) {
            alert('Username is already taken. Please choose another one.');
            return;
        }

        const { error } = await supabase
            .from('profiles')
            .update({
                username: username,
                email: email,
                mobile: mobile,
                updated_at: new Date().toISOString()
            })
            .eq('id', simpleAuth.currentUser.id);

        if (error) throw error;

        // Update local user data
        simpleAuth.currentUser.username = username;
        simpleAuth.currentUser.email = email;
        simpleAuth.currentUser.mobile = mobile;
        localStorage.setItem('casino_user', JSON.stringify(simpleAuth.currentUser));

        // Update UI
        simpleAuth.updateAccountInfo();

        alert('Profile updated successfully!');
        closeModal('editProfileModal');

    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}

// Show Change Password
function showChangePassword() {
    if (!simpleAuth.isLoggedIn()) {
        alert('Please login to change password');
        return;
    }

    document.getElementById('changePasswordModal').style.display = 'block';
}

// Change Password
async function changeUserPassword() {
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('Please fill all password fields');
            return;
        }

        if (newPassword.length < 6) {
            alert('New password must be at least 6 characters long');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match');
            return;
        }

        // Verify current password
        const hashedCurrentPassword = simpleAuth.hashPassword(currentPassword);
        if (hashedCurrentPassword !== simpleAuth.currentUser.password) {
            alert('Current password is incorrect');
            return;
        }

        // Hash new password
        const hashedNewPassword = simpleAuth.hashPassword(newPassword);

        // Update password in database
        const { error } = await supabase
            .from('profiles')
            .update({
                password: hashedNewPassword,
                updated_at: new Date().toISOString()
            })
            .eq('id', simpleAuth.currentUser.id);

        if (error) throw error;

        // Update local user data
        simpleAuth.currentUser.password = hashedNewPassword;
        localStorage.setItem('casino_user', JSON.stringify(simpleAuth.currentUser));

        alert('Password changed successfully!');
        document.getElementById('changePasswordForm').reset();
        closeModal('changePasswordModal');

    } catch (error) {
        console.error('Error changing password:', error);
        alert('Failed to change password: ' + error.message);
    }
}

// Logout User
function logoutUser() {
    if (confirm('Are you sure you want to logout?')) {
        simpleAuth.logout();
        alert('You have been logged out successfully!');
    }
}

// Close Modal
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Update Account Info Display
function updateAccountDisplay() {
    if (!simpleAuth.currentUser) return;

    const user = simpleAuth.currentUser;
    
    // Update account info display
    document.getElementById('accountUsername').textContent = user.username || 'N/A';
    document.getElementById('accountMobile').textContent = user.mobile || 'N/A';
    document.getElementById('accountEmail').textContent = user.email || 'N/A';
    document.getElementById('accountMemberSince').textContent = user.member_since ? new Date(user.member_since).toLocaleDateString() : 'N/A';
    document.getElementById('accountVipLevel').textContent = user.vip_level || 'Bronze';
    document.getElementById('accountBalance').textContent = `$${(user.balance || 0).toFixed(2)}`;
    document.getElementById('accountBonusBalance').textContent = `$${(user.pending_bonus || 0).toFixed(2)}`;
}

// Update SimpleAuth to use this function
// Add this to your simple-auth.js in the updateAccountInfo method:
/*
updateAccountInfo() {
    if (!this.currentUser) return;
    updateAccountDisplay(); // Call the new display function
}
*/


// Referral System Functions

// Load referral data
async function loadReferralData() {
    if (!simpleAuth.isLoggedIn()) return;

    try {
        // Load user's referral stats
        const user = simpleAuth.currentUser;
        
        // Update the referral code display
        const referralCodeElement = document.getElementById('userReferralCode');
        if (referralCodeElement) {
            referralCodeElement.textContent = user.referral_code || 'N/A';
        }
        
        // Update referral stats - FIXED: using ৳ instead of $
        document.getElementById('friendsReferred').textContent = user.friends_referred || 0;
        document.getElementById('totalEarnings').textContent = `৳${(user.total_earnings || 0).toFixed(2)}`;
        document.getElementById('pendingBonus').textContent = `৳${(user.pending_bonus || 0).toFixed(2)}`;

        // Load referral history
        await loadReferralHistory();

    } catch (error) {
        console.error('Error loading referral data:', error);
    }
}

// Load referral history
async function loadReferralHistory() {
    try {
        const { data: referrals, error } = await supabase
            .from('referrals')
            .select(`
                *,
                referred_user:profiles!referred_id(username, mobile)
            `)
            .eq('referrer_id', simpleAuth.currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        displayReferralHistory(referrals);

    } catch (error) {
        console.error('Error loading referral history:', error);
    }
}

// Display referral history
function displayReferralHistory(referrals) {
    const tbody = document.getElementById('referralHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    if (!referrals || referrals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 20px;">
                    No referrals yet. Share your code to start earning!
                </td>
            </tr>
        `;
        return;
    }

    referrals.forEach(ref => {
        const row = document.createElement('tr');
        const date = new Date(ref.created_at).toLocaleDateString();
        const statusColor = ref.status === 'completed' ? '#4CAF50' : 
                           ref.status === 'pending' ? '#ff9800' : '#f44336';
        
        row.innerHTML = `
            <td>${ref.referred_user?.username || 'New User'}</td>
            <td>${date}</td>
            <td>
                <span style="color: ${statusColor}">
                    ${ref.status?.toUpperCase() || 'PENDING'}
                </span>
            </td>
            <td>${ref.referrer_bonus ? `৳${ref.referrer_bonus.toFixed(2)}` : '-'}</td>
            <td>${ref.referred_bonus ? `৳${ref.referred_bonus.toFixed(2)}` : '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Share functions
function shareReferralCode() {
    const code = simpleAuth.currentUser?.referral_code;
    if (!code) return;

    const message = `Join Lucky Spin Casino using my referral code: ${code}. Get ৳100 free bonus! 🎰✨`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Join Lucky Spin Casino',
            text: message,
            url: window.location.href
        });
    } else {
        copyReferralLink();
    }
}

function copyReferralLink() {
    const code = simpleAuth.currentUser?.referral_code;
    if (!code) return;

    const link = `${window.location.origin}?ref=${code}`;
    navigator.clipboard.writeText(link).then(() => {
        alert('Referral link copied to clipboard!');
    });
}

function shareOnWhatsApp() {
    const code = simpleAuth.currentUser?.referral_code;
    if (!code) return;

    const message = `Join Lucky Spin Casino! Use my code ${code} for $10 free bonus. 🎰 ${window.location.href}?ref=${code}`;
    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function shareOnFacebook() {
    const code = simpleAuth.currentUser?.referral_code;
    if (!code) return;

    const message = `Join Lucky Spin Casino with my referral code ${code} and get $10 free!`;
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}?ref=${code}&quote=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

function shareOnTelegram() {
    const code = simpleAuth.currentUser?.referral_code;
    if (!code) return;

    const message = `Join Lucky Spin Casino! Use my code ${code} for $10 free bonus. 🎰`;
    const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}?ref=${code}&text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// Check for referral code in URL on page load
function checkUrlForReferralCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    
    if (refCode && !simpleAuth.isLoggedIn()) {
        // Store referral code for use during registration
        localStorage.setItem('pending_referral', refCode);
        console.log('Referral code detected:', refCode);
    }
}

// Update registration to use stored referral code
// Modify your registration function to check for stored referral code

// Initialize referral system
document.addEventListener('DOMContentLoaded', function() {
    checkUrlForReferralCode();
});









// Deposit page initialization
function initDepositPage() {
    console.log('Initializing deposit page...');
    
    // Add click events to payment method cards
    document.querySelectorAll('.method-card').forEach(card => {
        card.addEventListener('click', function() {
            const method = this.getAttribute('data-method');
            selectPaymentMethod(method);
        });
    });

    // Deposit form submission
    const depositBtn = document.getElementById('depositBtn');
    if (depositBtn) {
        depositBtn.addEventListener('click', processDeposit);
    }
}

// Select payment method
function selectPaymentMethod(method) {
    const paymentMethods = {
        'bkash': '01712345678',
        'nagad': '01887654321',
        'rocket': '01911223344',
        'crypto': 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh'
    };
    
    const paymentNumberInput = document.getElementById('paymentNumber');
    if (paymentNumberInput && paymentMethods[method]) {
        paymentNumberInput.value = paymentMethods[method];
    }
    
    // Update dropdown
    const paymentMethodSelect = document.getElementById('paymentMethod');
    if (paymentMethodSelect) {
        paymentMethodSelect.value = method;
    }
}

// Process deposit
async function processDeposit() {
    const amount = document.getElementById('depositAmount')?.value;
    const transactionId = document.getElementById('transactionId')?.value;
    const paymentMethod = document.getElementById('paymentMethod')?.value;

    if (!amount || amount < 200) {
        alert('Minimum deposit amount is ৳200');
        return;
    }

    if (!transactionId) {
        alert('Please enter your transaction ID');
        return;
    }

    if (!paymentMethod) {
        alert('Please select a payment method');
        return;
    }

    alert(`Your Deposit request Submitted: ৳${amount} via ${paymentMethod} - TRX: ${transactionId}`);
}

// Create popup HTML and style dynamically
const popupHTML = `
  <div id="deposit-popup" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  ">
    <div style="
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      text-align: center;
      max-width: 320px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      animation: fadeIn 0.3s ease;
    ">
      <h3 style="margin-bottom: 10px; color:#333;">Deposit Required</h3>
      <p style="color:#555; font-size:15px;">Please deposit first before playing the game.</p>
      <div style="margin-top: 20px;">
        <button id="ok-deposit" style="
          background:#007bff;
          color:#fff;
          border:none;
          padding:8px 18px;
          border-radius:8px;
          cursor:pointer;
        ">OK</button>
        <button id="cancel-popup" style="
          background:#ccc;
          color:#000;
          border:none;
          padding:8px 18px;
          border-radius:8px;
          margin-left:10px;
          cursor:pointer;
        ">Cancel</button>
      </div>
    </div>
  </div>
`;

// Function to show popup
function showDepositPopup() {
  if (!document.getElementById('deposit-popup')) {
    document.body.insertAdjacentHTML('beforeend', popupHTML);

    // When OK clicked, simulate clicking the deposit page button
    document.getElementById('ok-deposit').addEventListener('click', () => {
      document.getElementById('deposit-popup').remove();

      // find the element with data-page="depositPage" and trigger click
      const depositBtn = document.querySelector('[data-page="depositPage"]');
      if (depositBtn) {
        depositBtn.click();
      } else {
        console.warn('⚠️ depositPage element not found.');
      }
    });

    // Cancel closes popup
    document.getElementById('cancel-popup').addEventListener('click', () => {
      document.getElementById('deposit-popup').remove();
    });
  }
}

// Attach popup to all .play-game elements
document.querySelectorAll('.play-game').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();
    showDepositPopup();
  });
});


// Withdraw functionality
function initWithdrawSection() {
    console.log('Initializing withdraw section...');
    
    // Update balance display
    updateWithdrawBalance();
    
    // Add event listeners
    const withdrawBtn = document.getElementById('withdrawBtn');
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', processWithdrawal);
    }
    
    // Load withdrawal history
    loadWithdrawalHistory();
    
    // Add input validation
    addWithdrawInputValidation();
}

// Update withdraw balance display
function updateWithdrawBalance() {
    if (simpleAuth.isLoggedIn() && simpleAuth.currentUser) {
        const balanceElement = document.getElementById('withdrawBalance');
        if (balanceElement) {
            balanceElement.textContent = `৳${(simpleAuth.currentUser.balance || 0).toFixed(2)}`;
        }
    }
}

// Add input validation
function addWithdrawInputValidation() {
    const amountInput = document.getElementById('withdrawAmount');
    const mobileInput = document.getElementById('withdrawMobile');
    
    if (amountInput) {
        amountInput.addEventListener('input', function() {
            const amount = parseFloat(this.value);
            const balance = simpleAuth.currentUser?.balance || 0;
            
            if (amount > balance) {
                this.setCustomValidity('Insufficient balance');
            } else if (amount < 500) {
                this.setCustomValidity('Minimum withdrawal is ৳500');
            } else if (amount > 50000) {
                this.setCustomValidity('Maximum withdrawal is ৳50,000');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    if (mobileInput) {
        mobileInput.addEventListener('input', function() {
            const mobile = this.value;
            if (mobile.length === 11 && /^01[3-9]\d{8}$/.test(mobile)) {
                this.setCustomValidity('');
            } else {
                this.setCustomValidity('Please enter a valid Bangladeshi mobile number');
            }
        });
    }
}

// Process withdrawal
async function processWithdrawal() {
    if (!simpleAuth.isLoggedIn()) {
        alert('Please login to withdraw funds');
        return;
    }

    const method = document.getElementById('withdrawMethod').value;
    const mobile = document.getElementById('withdrawMobile').value;
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const accountName = document.getElementById('accountHolderName').value;
    const balance = simpleAuth.currentUser.balance || 0;

    // Validation
    if (!method) {
        alert('Please select a payment method');
        return;
    }

    if (!mobile || !/^01[3-9]\d{8}$/.test(mobile)) {
        alert('Please enter a valid 11-digit Bangladeshi mobile number');
        return;
    }

    if (!amount || amount < 500) {
        alert('Minimum withdrawal amount is ৳500');
        return;
    }

    if (amount > 50000) {
        alert('Maximum withdrawal amount is ৳50,000 per day');
        return;
    }

    if (amount > balance) {
        alert('Insufficient balance for this withdrawal');
        return;
    }

    if (!accountName.trim()) {
        alert('Please enter account holder name');
        return;
    }

    try {
        const withdrawBtn = document.getElementById('withdrawBtn');
        withdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSING...';
        withdrawBtn.disabled = true;

        // Calculate new balance
        const newBalance = balance - amount;

        // Update user balance in database
        const { error: balanceError } = await supabase
            .from('profiles')
            .update({ balance: newBalance })
            .eq('id', simpleAuth.currentUser.id);

        if (balanceError) throw balanceError;

        // Record withdrawal transaction
        const { error: withdrawError } = await supabase
            .from('withdrawals')
            .insert([
                {
                    user_id: simpleAuth.currentUser.id,
                    method: method,
                    mobile: mobile,
                    amount: amount,
                    account_name: accountName.trim(),
                    status: 'pending',
                    transaction_id: 'WD' + Date.now()
                }
            ]);

        if (withdrawError) {
            // If withdrawals table doesn't exist, just update balance and show success
            console.log('Withdrawals table not found, but balance updated');
        }

        // Record transaction history
        const { error: txError } = await supabase
            .from('transactions')
            .insert([
                {
                    user_id: simpleAuth.currentUser.id,
                    type: 'withdrawal',
                    amount: -amount,
                    description: `Withdrawal to ${method} (${mobile})`,
                    status: 'pending'
                }
            ]);

        if (txError) throw txError;

        // Update local user data
        simpleAuth.currentUser.balance = newBalance;
        localStorage.setItem('casino_user', JSON.stringify(simpleAuth.currentUser));

        // Update UI
        simpleAuth.updateAllUserSections();
        updateWithdrawBalance();
        loadWithdrawalHistory();

        alert(`✅ Withdrawal request submitted!\n\nAmount: ৳${amount}\nMethod: ${method}\nMobile: ${mobile}\n\nYour withdrawal will be processed within 1-6 hours.`);

        // Reset form
        document.getElementById('withdrawMethod').value = '';
        document.getElementById('withdrawMobile').value = '';
        document.getElementById('withdrawAmount').value = '';
        document.getElementById('accountHolderName').value = '';

    } catch (error) {
        console.error('Withdrawal error:', error);
        alert('Withdrawal failed: ' + error.message);
    } finally {
        const withdrawBtn = document.getElementById('withdrawBtn');
        withdrawBtn.innerHTML = '<i class="fas fa-paper-plane"></i> WITHDRAW NOW';
        withdrawBtn.disabled = false;
    }
}

// Load withdrawal history
async function loadWithdrawalHistory() {
    if (!simpleAuth.isLoggedIn()) return;

    try {
        const { data: withdrawals, error } = await supabase
            .from('withdrawals')
            .select('*')
            .eq('user_id', simpleAuth.currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);

        if (error) {
            // If table doesn't exist, show empty state
            displayWithdrawalHistory([]);
            return;
        }

        displayWithdrawalHistory(withdrawals);

    } catch (error) {
        console.error('Error loading withdrawal history:', error);
        displayWithdrawalHistory([]);
    }
}

// Display withdrawal history
function displayWithdrawalHistory(withdrawals) {
    const tbody = document.getElementById('withdrawHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    if (!withdrawals || withdrawals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px;">
                    No withdrawal history found
                </td>
            </tr>
        `;
        return;
    }

    withdrawals.forEach(withdrawal => {
        const row = document.createElement('tr');
        const date = new Date(withdrawal.created_at).toLocaleDateString();
        const statusClass = `status-${withdrawal.status}`;
        
        row.innerHTML = `
            <td>${date}</td>
            <td>${withdrawal.method.toUpperCase()}</td>
            <td style="color: #f44336; font-weight: bold;">-৳${withdrawal.amount?.toFixed(2) || '0.00'}</td>
            <td>
                <span class="${statusClass}">${withdrawal.status.toUpperCase()}</span>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update the deposit page initialization to include withdraw
function initDepositPage() {
    console.log('Initializing deposit page...');
    
    // Your existing deposit initialization
    document.querySelectorAll('.method-card').forEach(card => {
        card.addEventListener('click', function() {
            const method = this.getAttribute('data-method');
            selectPaymentMethod(method);
        });
    });

    const depositBtn = document.getElementById('depositBtn');
    if (depositBtn) {
        depositBtn.addEventListener('click', processDeposit);
    }
    
    // Initialize withdraw section
    initWithdrawSection();
}